#!/usr/bin/env python3
"""
ะัะฝะพะฒะฝะพะน ัะตัะฒะตั ะดะปั ะทะฐะฟััะบะฐ ะฒะตะฑ-ะธะฝัะตััะตะนัะฐ ัะพัะณะพะฒะพะณะพ ะฑะพัะฐ.
ะญัะฐ ะฒะตััะธั ะธัะฟัะฐะฒะปัะตั ะพัะธะฑะบั 'AttributeError: 'tuple' object has no attribute 'debug'',
ะบะพัะพัะฐั ะฒะพะทะฝะธะบะฐะตั ะธะท-ะทะฐ ะฝะตะฟัะฐะฒะธะปัะฝะพะน ะพะฑัะฐะฑะพัะบะธ ะฒะพะทะฒัะฐัะฐะตะผะพะณะพ ะทะฝะฐัะตะฝะธั ะธะท create_app().

ะะฐะฟััะบ ะธะท ะบะพัะฝะตะฒะพะน ะดะธัะตะบัะพัะธะธ ะฟัะพะตะบัะฐ:
    python server.py
"""

import os
import sys
import logging
from pathlib import Path

# --- ะะฐัััะพะนะบะฐ ะฟััะตะน ะธ ะปะพะณะธัะพะฒะฐะฝะธั ---
ROOT_DIR = Path(__file__).resolve().parent
if str(ROOT_DIR) not in sys.path:
    sys.path.insert(0, str(ROOT_DIR))

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - [%(levelname)s] - %(message)s',
    datefmt='%Y-%m-%d %H:%M:%S'
)
logger = logging.getLogger("server_main")

def main():
    """
    ะัะฝะพะฒะฝะฐั ััะฝะบัะธั ะดะปั ะบะพะฝัะธะณััะฐัะธะธ ะธ ะทะฐะฟััะบะฐ ะฒะตะฑ-ัะตัะฒะตัะฐ.
    """
    
    # --- ะจะฐะณ 1: ะะผะฟะพัั ะธ ัะพะทะดะฐะฝะธะต ะฟัะธะปะพะถะตะฝะธั ---
    logger.info("ะะผะฟะพัั ะธ ัะพะทะดะฐะฝะธะต ะฟัะธะปะพะถะตะฝะธั ัะตัะตะท ัะฐะฑัะธะบั `create_app`...")
    try:
        from src.web.app import create_app
        # ะะะะะะะฌะะซะ ะกะะะกะะ: ะะฐัะฟะฐะบะพะฒัะฒะฐะตะผ ะบะพััะตะถ, ะฒะพะทะฒัะฐัะฐะตะผัะน ััะฝะบัะธะตะน.
        # ะญัะพ ะธัะฟัะฐะฒะปัะตั ะพัะธะฑะบั "'tuple' object has no attribute 'debug'"
        app, socketio = create_app()
        
        # ะัะพะฒะตัะบะฐ, ััะพ ะผั ะฟะพะปััะธะปะธ ะฟัะฐะฒะธะปัะฝัะต ะพะฑัะตะบัั, ััะพะฑั ะธะทะฑะตะถะฐัั ะฑัะดััะธั ะพัะธะฑะพะบ
        if not hasattr(app, 'run'):
            raise RuntimeError("ะะตัะฒัะน ะฒะพะทะฒัะฐัะฐะตะผัะน ะพะฑัะตะบั ะธะท create_app ะฝะต ัะฒะปัะตััั Flask-ะฟัะธะปะพะถะตะฝะธะตะผ.")
        if not hasattr(socketio, 'run'):
             raise RuntimeError("ะัะพัะพะน ะฒะพะทะฒัะฐัะฐะตะผัะน ะพะฑัะตะบั ะธะท create_app ะฝะต ัะฒะปัะตััั SocketIO-ัะบะทะตะผะฟะปััะพะผ.")

        logger.info("โ ะัะธะปะพะถะตะฝะธะต ะธ SocketIO ััะฟะตัะฝะพ ัะพะทะดะฐะฝั ะธ ะธะฝะธัะธะฐะปะธะทะธัะพะฒะฐะฝั.")

    except (ImportError, ValueError, RuntimeError) as e:
        # ValueError ะปะพะฒะธะผ ะฝะฐ ัะปััะฐะน, ะตัะปะธ create_app ะฒะตัะฝะตั ะฝะต 2 ะทะฝะฐัะตะฝะธั (cannot unpack)
        logger.error("="*20 + " ะะะะขะะงะะกะะะฏ ะะจะะะะ ะะะะฃะกะะ " + "="*20)
        logger.error(f"โ ะะต ัะดะฐะปะพัั ัะพะทะดะฐัั ะฟัะธะปะพะถะตะฝะธะต: {e}", exc_info=True)
        logger.error("     ะฃะฑะตะดะธัะตัั, ััะพ ััะฝะบัะธั `create_app()` ะฒ `src/web/app.py` ะฒะพะทะฒัะฐัะฐะตั `(app, socketio)`.")
        sys.exit(1)

    # --- ะจะฐะณ 2: ะะฐัััะพะนะบะฐ ะธ ะทะฐะฟััะบ ัะตัะฒะตัะฐ ---
    host = os.environ.get('HOST', '0.0.0.0')
    port = int(os.environ.get('PORT', 5000))
    debug_mode = os.environ.get('FLASK_DEBUG', 'False').lower() in ['true', '1', 't']

    print(f"""
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ               ๐ SERVER STARTING - BOT v3.0 ๐                 โ
โ             Professional Trading Bot Dashboard               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฃ
โ  โ ะฃะฝะธัะธัะธัะพะฒะฐะฝะฝัะน ัะตัะฒะตั (Web, API, WebSocket) ะทะฐะฟััะตะฝ!    โ
โ  URL: http://{'127.0.0.1' if host == '0.0.0.0' else host}:{port}                                     โ
โ  ะะตะถะธะผ ะพัะปะฐะดะบะธ: {'ะะะะฎะงะะ' if debug_mode else 'ะะซะะะฎะงะะ'}                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    """)

    try:
        logger.info(f"ะกะตัะฒะตั ะณะพัะพะฒ ะบ ะฟัะธะตะผั ะฟะพะดะบะปััะตะฝะธะน ะฝะฐ http://{host}:{port}")
        # ะะฐะฟััะบะฐะตะผ ัะตัะฒะตั ัะตัะตะท ะพะฑัะตะบั socketio, ะฟะตัะตะดะฐะฒะฐั ะตะผั app
        socketio.run(
            app,
            host=host,
            port=port,
            debug=debug_mode,
            allow_unsafe_werkzeug=True,
            log_output=debug_mode
        )
    except Exception as e:
        logger.error(f"โ ะะต ัะดะฐะปะพัั ะทะฐะฟัััะธัั ัะตัะฒะตั: {e}", exc_info=True)
    finally:
        logger.info("๐ ะกะตัะฒะตั ะพััะฐะฝะพะฒะปะตะฝ.")


if __name__ == '__main__':
    main()