#!/usr/bin/env python3
"""
ğŸš€ ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞĞ«Ğ™ Ğ“Ğ›ĞĞ’ĞĞ«Ğ™ Ğ¤ĞĞ™Ğ› Ğ—ĞĞŸĞ£Ğ¡ĞšĞ CRYPTO TRADING BOT
Ğ¤Ğ°Ğ¹Ğ»: main.py

âœ… ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞ˜Ğ• Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ¯:
- Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ñ await Ğ¸ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ¾Ğ¹ Ñ„ÑƒĞ½ĞºÑ†Ğ¸ĞµĞ¹
- ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ°Ñ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ‡Ğ° config Ğ² ĞºĞ¾Ğ½ÑÑ‚Ñ€ÑƒĞºÑ‚Ğ¾Ñ€ TradingBotWithRealTrading
- Ğ£Ğ»ÑƒÑ‡ÑˆĞµĞ½Ğ½Ğ°Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ´Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ° Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼
- ĞšĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ°Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° fallback ÑÑ†ĞµĞ½Ğ°Ñ€Ğ¸ĞµĞ²
"""

import sys
import os
import asyncio
import logging
import threading
import time
from pathlib import Path
from dotenv import load_dotenv
import signal
from typing import Optional, Dict, Any

# ========================================
# ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ ĞĞšĞ Ğ£Ğ–Ğ•ĞĞ˜Ğ¯ Ğ˜ ĞŸĞ£Ğ¢Ğ•Ğ™
# ========================================

# Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ¾Ñ€Ğ½ĞµĞ²ÑƒÑ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ² PYTHONPATH
ROOT_DIR = Path(__file__).parent
sys.path.insert(0, str(ROOT_DIR))

# Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ
env_path = ROOT_DIR / '.env'
if not env_path.exists():
    # Ğ˜Ñ‰ĞµĞ¼ Ğ² Ğ´Ñ€ÑƒĞ³Ğ¸Ñ… Ğ¼ĞµÑÑ‚Ğ°Ñ…
    possible_paths = [
        ROOT_DIR / 'config' / '.env',
        ROOT_DIR / '.env.example',
        Path('/etc/crypto/config/.env')
    ]
    for path in possible_paths:
        if path.exists():
            env_path = path
            break

load_dotenv(env_path)

# ĞŸĞ¾Ğ´Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¿Ñ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ñ
os.environ.setdefault('TF_CPP_MIN_LOG_LEVEL', '3')
os.environ.setdefault('TF_ENABLE_ONEDNN_OPTS', '0')
os.environ.setdefault('PYTHONPATH', str(ROOT_DIR))

# ========================================
# ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ Ğ›ĞĞ“Ğ˜Ğ ĞĞ’ĞĞĞ˜Ğ¯
# ========================================

def setup_logging():
    """ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ"""
    
    # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ´Ğ»Ñ Ğ»Ğ¾Ğ³Ğ¾Ğ²
    log_dir = ROOT_DIR / 'logs'
    log_dir.mkdir(exist_ok=True)
    
    # ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ñ‚ĞµÑ€Ğ°
    formatter = logging.Formatter(
        '%(asctime)s - %(name)s - %(levelname)s - %(message)s',
        datefmt='%Y-%m-%d %H:%M:%S'
    )
    
    # ĞšĞ¾Ğ½ÑĞ¾Ğ»ÑŒĞ½Ñ‹Ğ¹ handler
    console_handler = logging.StreamHandler()
    console_handler.setLevel(logging.INFO)
    console_handler.setFormatter(formatter)
    
    # Ğ¤Ğ°Ğ¹Ğ»Ğ¾Ğ²Ñ‹Ğ¹ handler
    file_handler = logging.FileHandler(log_dir / 'main.log')
    file_handler.setLevel(logging.DEBUG)
    file_handler.setFormatter(formatter)
    
    # ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° root logger
    root_logger = logging.getLogger()
    root_logger.setLevel(logging.INFO)
    root_logger.addHandler(console_handler)
    root_logger.addHandler(file_handler)
    
    return root_logger

# Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
logger = setup_logging()

# ========================================
# ĞšĞ ĞĞ¡Ğ˜Ğ’Ğ«Ğ™ Ğ‘ĞĞĞĞ•Ğ  Ğ—ĞĞŸĞ£Ğ¡ĞšĞ
# ========================================

def show_startup_banner():
    """ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ±Ğ°Ğ½Ğ½ĞµÑ€ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°"""
    banner = """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    ğŸš€ CRYPTO TRADING BOT v3.1                â•‘
â•‘                  Professional Trading System                 â•‘
â•‘                        SYSTEMETECH                           â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  âœ… ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²Ğ»Ğ¸                            â•‘
â•‘  ğŸ§  ĞœĞ°ÑˆĞ¸Ğ½Ğ½Ğ¾Ğµ Ğ¾Ğ±ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ¸ Ğ˜Ğ˜                                   â•‘
â•‘  ğŸŒ Ğ’ĞµĞ±-Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸                          â•‘
â•‘  ğŸ›¡ï¸ ĞŸÑ€Ğ¾Ğ´Ğ²Ğ¸Ğ½ÑƒÑ‚Ñ‹Ğ¹ Ñ€Ğ¸ÑĞº-Ğ¼ĞµĞ½ĞµĞ´Ğ¶Ğ¼ĞµĞ½Ñ‚                              â•‘
â•‘  ğŸ“Š Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ Ñ Bybit                                       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""
    print(banner)

# ========================================
# Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞĞ«Ğ• ĞŸĞ ĞĞ’Ğ•Ğ ĞšĞ˜
# ========================================

def check_environment():
    """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ"""
    logger.info("ğŸ”§ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ...")
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Python Ğ²ĞµÑ€ÑĞ¸Ñ
    if sys.version_info < (3, 8):
        logger.error("âŒ Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Python 3.8+")
        return False
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
    optional_env_vars = [
        'DATABASE_URL',
        'BYBIT_API_KEY',
        'BYBIT_API_SECRET'
    ]
    
    missing_vars = []
    for var in optional_env_vars:
        if not os.getenv(var):
            missing_vars.append(var)
    
    if missing_vars:
        logger.warning(f"âš ï¸ ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒÑÑ‚ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ: {missing_vars}")
        logger.info("â„¹ï¸ Ğ‘ÑƒĞ´ĞµÑ‚ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒÑÑ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ Ñ€ĞµĞ¶Ğ¸Ğ¼")
    
    logger.info("âœ… ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°")
    return True

async def check_system_components():
    """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ñ… ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ¾Ğ²"""
    logger.info("ğŸ” ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ñ… ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ¾Ğ²...")
    
    results = {
        'environment': False,
        'database': False,
        'exchange': False,
        'ml_capabilities': False,
        'bot_components': False
    }
    
    # 1. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ
    results['environment'] = check_environment()
    
    # 2. âœ… Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ•: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ‘Ğ•Ğ— await
    try:
        from src.core.database import test_database_connection
        # âœ… Ğ£Ğ‘Ğ˜Ğ ĞĞ•Ğœ await - Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ°Ñ!
        results['database'] = test_database_connection()
        if results['database']:
            logger.info("âœ… Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ°")
        else:
            logger.warning("âš ï¸ ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹ Ñ Ğ±Ğ°Ğ·Ğ¾Ğ¹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…")
    except Exception as e:
        logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ‘Ğ”: {e}")
        # ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°ĞµĞ¼ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñƒ Ğ±ĞµĞ· Ğ‘Ğ” Ğ² Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ğ¾Ğ¼ Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ
        results['database'] = False
    
    # 3. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° exchange
    try:
        from src.exchange import check_exchange_capabilities
        exchange_caps = check_exchange_capabilities()
        results['exchange'] = exchange_caps.get('full_exchange_stack', False)
        
        if results['exchange']:
            logger.info("âœ… Exchange ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ°")
        else:
            logger.warning("âš ï¸ ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ½Ñ‹Ğµ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚Ğ¸ exchange")
    except Exception as e:
        logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ exchange: {e}")
        results['exchange'] = False
    
    # 4. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ML
    try:
        from src.ml import check_ml_capabilities
        ml_caps = check_ml_capabilities()
        results['ml_capabilities'] = ml_caps.get('production_ready', False)
        
        if results['ml_capabilities']:
            logger.info("âœ… ML ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ°")
        else:
            logger.warning("âš ï¸ ML ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ñ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸ÑĞ¼Ğ¸")
    except Exception as e:
        logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ ML: {e}")
        results['ml_capabilities'] = False
    
    # 5. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° bot ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ¾Ğ²
    try:
        from src.bot import check_bot_capabilities
        bot_caps = check_bot_capabilities()
        results['bot_components'] = bot_caps.get('full_bot_stack', False)
        
        if results['bot_components']:
            logger.info("âœ… Bot ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ñ‹")
        else:
            logger.warning("âš ï¸ Bot ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ñ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸ÑĞ¼Ğ¸")
    except Exception as e:
        logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ bot: {e}")
        results['bot_components'] = False
    
    # Ğ˜Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ğ°Ñ Ğ¾Ñ†ĞµĞ½ĞºĞ°
    critical_components = ['environment']  # Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ²Ğ°Ğ¶Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹
    critical_passed = all(results[comp] for comp in critical_components)
    
    if critical_passed:
        logger.info("âœ… ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ²Ğ°Ğ¶Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ñ‹")
        return True
    else:
        failed = [comp for comp in critical_components if not results[comp]]
        logger.warning(f"âš ï¸ Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° Ñ‡Ğ°ÑÑ‚Ğ¸Ñ‡Ğ½Ğ¾ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ° - Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹: {failed}")
        return False

# ========================================
# Ğ—ĞĞŸĞ£Ğ¡Ğš Ğ¢ĞĞ Ğ“ĞĞ’ĞĞ“Ğ Ğ‘ĞĞ¢Ğ
# ========================================

async def run_trading_bot():
    """Ğ—Ğ°Ğ¿ÑƒÑĞº Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ±Ğ¾Ñ‚Ğ°"""
    logger.info("ğŸ¤– Ğ—Ğ°Ğ¿ÑƒÑĞº Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ±Ğ¾Ñ‚Ğ°...")
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹
    system_ready = await check_system_components()
    if not system_ready:
        logger.warning("âš ï¸ Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° Ğ½Ğµ Ğ¿Ğ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ°, Ğ½Ğ¾ Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°ĞµĞ¼ Ğ² Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ğ¾Ğ¼ Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ")
    
    # âœ… Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ: Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ°Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸
    try:
        from src.core.unified_config import unified_config as config
        logger.info("âœ… ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ°")
        
        # Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ¸Ñ€ÑƒĞµĞ¼ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ
        if not config.validate_config():
            logger.error("âŒ ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸")
            return False
            
    except ImportError as e:
        logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸: {e}")
        return False
    
    # âœ… Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ: Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ±Ğ¾Ñ‚Ğ° Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸ĞµĞ¹
    bot_config = {
        'trading_enabled': True,
        'testnet': getattr(config, 'TESTNET', True),
        'max_positions': getattr(config, 'MAX_POSITIONS', 10),
        'risk_per_trade': getattr(config, 'RISK_PER_TRADE_PERCENT', 1.0) / 100,
        'stop_loss_percent': getattr(config, 'STOP_LOSS_PERCENT', 2.0) / 100,
        'take_profit_percent': getattr(config, 'TAKE_PROFIT_PERCENT', 4.0) / 100,
        'trading_pairs': getattr(config, 'TRADING_PAIRS', None) or ['BTCUSDT', 'ETHUSDT'],
        'analysis_interval': 60,  # ÑĞµĞºÑƒĞ½Ğ´Ñ‹
        'auto_strategy_selection': True,
        'emergency_stop_enabled': True
    }
    
    # Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ
    logger.info("ğŸ¯ ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ±Ğ¾Ñ‚Ğ°:")
    logger.info(f"   ğŸ”§ Ğ ĞµĞ¶Ğ¸Ğ¼: {'TESTNET' if bot_config['testnet'] else 'LIVE'}")
    logger.info(f"   ğŸ“Š ĞœĞ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¹: {bot_config['max_positions']}")
    logger.info(f"   âš ï¸ Ğ Ğ¸ÑĞº Ğ½Ğ° ÑĞ´ĞµĞ»ĞºÑƒ: {bot_config['risk_per_trade']*100:.1f}%")
    logger.info(f"   ğŸ›¡ï¸ Stop Loss: {bot_config['stop_loss_percent']*100:.1f}%")
    logger.info(f"   ğŸ¯ Take Profit: {bot_config['take_profit_percent']*100:.1f}%")
    logger.info(f"   ğŸ’° Ğ¢Ğ¾Ñ€Ğ³Ğ¾Ğ²Ñ‹Ğµ Ğ¿Ğ°Ñ€Ñ‹: {', '.join(bot_config['trading_pairs'])}")
    logger.info(f"   â±ï¸ Ğ˜Ğ½Ñ‚ĞµÑ€Ğ²Ğ°Ğ» Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°: {bot_config['analysis_interval']}Ñ")
    
    # Ğ’Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ ĞºĞ»Ğ°ÑÑ Ğ±Ğ¾Ñ‚Ğ°
    bot_class = None
    available_bots = [
        ('src.bot.manager', 'TradingBotWithRealTrading', 'TradingBotWithRealTrading'),
        ('src.bot.manager', 'BotManager', 'BotManager'),
        ('src.bot.trader', 'Trader', 'Trader'),
        ('src.bot.trading_integration', 'TradingIntegration', 'TradingIntegration'),
        ('src.bot.advanced_manager', 'AdvancedTradingBot', 'AdvancedTradingBot'),
    ]
    
    for module_name, class_name, display_name in available_bots:
        try:
            module = __import__(module_name, fromlist=[class_name])
            bot_class = getattr(module, class_name)
            logger.info(f"âœ… Ğ‘ÑƒĞ´ĞµĞ¼ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ {display_name}")
            break
        except (ImportError, AttributeError) as e:
            logger.debug(f"âš ï¸ {display_name} Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½: {e}")
            continue
    
    if bot_class is None:
        logger.error("âŒ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ½Ğ°Ğ¹Ñ‚Ğ¸ Ğ½Ğ¸ Ğ¾Ğ´Ğ¸Ğ½ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´ÑÑ‰Ğ¸Ğ¹ ĞºĞ»Ğ°ÑÑ Ğ±Ğ¾Ñ‚Ğ°")
        logger.info("ğŸ’¡ Ğ£Ğ±ĞµĞ´Ğ¸Ñ‚ĞµÑÑŒ Ñ‡Ñ‚Ğ¾ Ñ…Ğ¾Ñ‚Ñ Ğ±Ñ‹ Ğ¾Ğ´Ğ¸Ğ½ Ğ¸Ğ· bot Ğ¼Ğ¾Ğ´ÑƒĞ»ĞµĞ¹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½")
        return False
    
    # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ±Ğ¾Ñ‚Ğ°
    try:
        logger.info(f"ğŸ¯ Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ÑĞºĞ·ĞµĞ¼Ğ¿Ğ»ÑÑ€ {bot_class.__name__}...")
        
        # âœ… Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ: Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ±Ğ¾Ñ‚Ğ° Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¾Ğ¹ Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº
        try:
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ ĞºĞ¾Ğ½ÑÑ‚Ñ€ÑƒĞºÑ‚Ğ¾Ñ€ Ğ¿Ñ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ config
            import inspect
            signature = inspect.signature(bot_class.__init__)
            
            if 'config' in signature.parameters:
                bot = bot_class(config=bot_config)
                logger.info("âœ… ĞŸĞµÑ€ĞµĞ´Ğ°Ğ»Ğ¸ config Ğ² ĞºĞ¾Ğ½ÑÑ‚Ñ€ÑƒĞºÑ‚Ğ¾Ñ€")
            elif 'bot_config' in signature.parameters:
                bot = bot_class(bot_config=bot_config)
                logger.info("âœ… ĞŸĞµÑ€ĞµĞ´Ğ°Ğ»Ğ¸ bot_config Ğ² ĞºĞ¾Ğ½ÑÑ‚Ñ€ÑƒĞºÑ‚Ğ¾Ñ€")
            else:
                bot = bot_class()
                logger.info("âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ»Ğ¸ Ğ±Ğ¾Ñ‚Ğ° Ğ±ĞµĞ· Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ¾Ğ²")
                
        except Exception as init_error:
            logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ±Ğ¾Ñ‚Ğ°: {init_error}")
            logger.error(f"âŒ ĞšĞ»Ğ°ÑÑ: {bot_class.__name__}")
            return False
        
        # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ±Ğ¾Ñ‚Ğ°
        logger.info("ğŸš€ Ğ—Ğ°Ğ¿ÑƒÑĞº Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ±Ğ¾Ñ‚Ğ°...")
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ĞºĞ°ĞºĞ¾Ğ¹ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½
        if hasattr(bot, 'start') and callable(getattr(bot, 'start')):
            if asyncio.iscoroutinefunction(bot.start):
                await bot.start()
            else:
                bot.start()
        elif hasattr(bot, 'run') and callable(getattr(bot, 'run')):
            if asyncio.iscoroutinefunction(bot.run):
                await bot.run()
            else:
                bot.run()
        else:
            logger.error("âŒ ĞĞµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° Ğ±Ğ¾Ñ‚Ğ°")
            return False
        
        logger.info("âœ… Ğ¢Ğ¾Ñ€Ğ³Ğ¾Ğ²Ñ‹Ğ¹ Ğ±Ğ¾Ñ‚ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½!")
        return True
        
    except KeyboardInterrupt:
        logger.info("ğŸ›‘ ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½ ÑĞ¸Ğ³Ğ½Ğ°Ğ» Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸")
        return True
    except Exception as e:
        logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ±Ğ¾Ñ‚Ğ°: {e}")
        logger.exception("ğŸ“Š ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ñ‚Ñ€Ğ°ÑÑĞ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸:")
        return False

# ========================================
# Ğ—ĞĞŸĞ£Ğ¡Ğš Ğ’Ğ•Ğ‘-Ğ˜ĞĞ¢Ğ•Ğ Ğ¤Ğ•Ğ™Ğ¡Ğ
# ========================================

async def run_web_interface():
    """Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ²ĞµĞ±-Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹ÑĞ°"""
    logger.info("ğŸŒ Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ²ĞµĞ±-Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹ÑĞ°...")
    
    try:
        from src.web.app import create_app
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Flask Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ
        app = create_app()
        
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¿Ğ¾Ñ€Ñ‚ Ğ¸Ğ· ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸
        port = int(os.getenv('WEB_PORT', 5000))
        
        # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ÑĞµÑ€Ğ²ĞµÑ€
        logger.info(f"ğŸŒ Ğ’ĞµĞ±-Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½ Ğ½Ğ° http://localhost:{port}")
        app.run(host='0.0.0.0', port=port, debug=False)
        
        return True
        
    except Exception as e:
        logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° Ğ²ĞµĞ±-Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹ÑĞ°: {e}")
        return False

# ========================================
# Ğ“Ğ›ĞĞ’ĞĞĞ¯ Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ¯
# ========================================

async def main():
    """Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ"""
    show_startup_banner()
    
    # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ñ€ĞµĞ¶Ğ¸Ğ¼ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°
    if len(sys.argv) > 1:
        mode = sys.argv[1].lower()
    else:
        mode = 'bot'  # ĞŸĞ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ±Ğ¾Ñ‚Ğ°
    
    logger.info(f"ğŸ¯ Ğ ĞµĞ¶Ğ¸Ğ¼: {mode.title()}")
    
    try:
        if mode == 'bot':
            logger.info("ğŸ¤– Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ±Ğ¾Ñ‚Ğ°...")
            success = await run_trading_bot()
        elif mode == 'web':
            logger.info("ğŸŒ Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ²ĞµĞ±-Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹ÑĞ°...")
            success = await run_web_interface()
        elif mode == 'both':
            logger.info("ğŸš€ Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ¹ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹...")
            # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ±Ğ¾Ñ‚Ğ° Ğ² Ñ„Ğ¾Ğ½Ğµ
            bot_task = asyncio.create_task(run_trading_bot())
            # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ²ĞµĞ±-Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ
            web_task = asyncio.create_task(run_web_interface())
            
            # Ğ–Ğ´ĞµĞ¼ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ñ Ğ»ÑĞ±Ğ¾Ğ¹ Ğ¸Ğ· Ğ·Ğ°Ğ´Ğ°Ñ‡
            done, pending = await asyncio.wait(
                [bot_task, web_task], 
                return_when=asyncio.FIRST_COMPLETED
            )
            
            # ĞÑ‚Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ½ĞµĞ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸
            for task in pending:
                task.cancel()
                
            success = True
        elif mode == 'check':
            logger.info("ğŸ” ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹...")
            success = await check_system_components()
            logger.info("âœ… ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°")
        else:
            logger.error(f"âŒ ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğ¹ Ñ€ĞµĞ¶Ğ¸Ğ¼: {mode}")
            logger.info("ğŸ’¡ Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğµ Ñ€ĞµĞ¶Ğ¸Ğ¼Ñ‹: bot, web, both, check")
            success = False
        
        if success:
            logger.info("âœ… Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ğ»Ğ° Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñƒ")
        else:
            logger.error("âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸")
            
    except KeyboardInterrupt:
        logger.info("ğŸ›‘ ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½ ÑĞ¸Ğ³Ğ½Ğ°Ğ» Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸")
    except Exception as e:
        logger.error(f"âŒ ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°: {e}")
        logger.exception("ğŸ“Š ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ñ‚Ñ€Ğ°ÑÑĞ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸:")
    finally:
        logger.info("ğŸ Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹")

if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        logger.info("ğŸ›‘ ĞŸÑ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ° Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼")
    except Exception as e:
        logger.error(f"âŒ ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°: {e}")
        sys.exit(1)